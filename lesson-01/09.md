db.users.updateOne(
  { email: "john.doe@example.com" },
  {
    $set: {
      name: { first: "John", last: "Doe" },
      status: "active"
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b4a96da85b0152a66773'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

const result1 = db.users.updateOne(
  { email: "jane.doe@example.com" },
  { $set: { name: "Jane Doe" } },
  { upsert: true }
)
console.log(result1)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b4d16da85b0152a66779'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

const result2 = db.users.updateOne(
  { email: "jane.doe@example.com" },
  { $set: { name: "Jane Doe Updated" } },
  { upsert: true }
)
console.log(result2)

{
  acknowledged: true,
  insertedId: null,
  matchedCount: 1,
  modifiedCount: 1,
  upsertedCount: 0
}

db.users.updateOne(
  { email: "user@example.com" },
  {
    $set: {
      name: "User Name",
      lastLogin: new Date()  // Always update
    },
    $setOnInsert: {
      createdAt: new Date(),  // Only set on insert
      role: "customer",       // Only set on insert
      status: "active"        // Only set on insert
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b5546da85b0152a66782'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.users.updateOne(
  { email: "active.user@example.com" },
  {
    $set: {
      lastActive: new Date()
    },
    $setOnInsert: {
      firstSeen: new Date(),
      accountCreated: new Date()
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b5766da85b0152a66788'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.products.updateOne(
  { sku: "PRODUCT-SKU-123" },  // Unique identifier
  {
    $set: {
      name: "Product Name",
      price: 99.99,
      status: "active",
      updatedAt: new Date()
    },
    $setOnInsert: {
      sku: "PRODUCT-SKU-123",
      createdAt: new Date(),
      viewCount: 0,
      salesCount: 0
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b5946da85b0152a6678a'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.apiLogs.updateOne(
  {
    requestId: "unique-request-id-123",  // Unique per request
    endpoint: "/api/products"
  },
  {
    $set: {
      lastAttempt: new Date(),
      status: "completed"
    },
    $inc: {
      attemptCount: 1  // Track retries
    },
    $setOnInsert: {
      requestId: "unique-request-id-123",
      endpoint: "/api/products",
      firstAttempt: new Date(),
      userId: "user123"
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b5b26da85b0152a6678d'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.counters.updateOne(
  { _id: "orderNumber" },
  {
    $setOnInsert: {
      sequence: 1000  // Start at 1000
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: 'orderNumber',
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.counters.updateOne(
  { _id: "productViews" },
  {
    $inc: { count: 1 },
    $setOnInsert: {
      createdAt: new Date()
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: 'productViews',
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.sessions.updateOne(
  { sessionId: "session-abc-123" },
  {
    $set: {
      userId: "user123",
      lastActivity: new Date(),
      data: {
        cartItems: 3,
        currentPage: "/products"
      }
    },
    $setOnInsert: {
      createdAt: new Date(),
      sessionId: "session-abc-123"
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b6166da85b0152a6682b'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.sessions.updateOne(
  { sessionId: "session-xyz-456" },
  {
    $set: {
      userId: "user456",
      lastActivity: new Date(),
      expiresAt: new Date(Date.now() + 30 * 60 * 1000)  // 30 minutes
    },
    $setOnInsert: {
      createdAt: new Date()
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b6376da85b0152a66830'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.sessions.createIndex(
  { expiresAt: 1 },
  { expireAfterSeconds: 0 }
)

expiresAt_1

db.inventory.updateOne(
  { sku: "LAPTOP-DELL-XPS13" },
  {
    $set: {
      sku: "LAPTOP-DELL-XPS13",
      lastUpdated: new Date()
    },
    $setOnInsert: {
      quantity: 100,
      reservedQuantity: 0,
      createdAt: new Date()
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: ObjectId('68f8b6736da85b0152a66833'),
  matchedCount: 0,
  modifiedCount: 0,
  upsertedCount: 1
}

db.inventory.updateOne(
  {
    sku: "LAPTOP-DELL-XPS13",
    quantity: { $gte: 5 }  // Only if enough stock
  },
  {
    $inc: {
      quantity: -5,
      reservedQuantity: 5
    },
    $set: {
      lastUpdated: new Date()
    }
  }
)

{
  acknowledged: true,
  insertedId: null,
  matchedCount: 1,
  modifiedCount: 1,
  upsertedCount: 0
}

db.users.updateOne(
  { email: "user@example.com" },
  {
    $set: {
      "preferences.theme": "dark",
      "preferences.lastUpdated": new Date()
    },
    $setOnInsert: {
      "preferences.language": "en",
      "preferences.notifications": true,
      "preferences.newsletter": false
    }
  },
  { upsert: true }
)

{
  acknowledged: true,
  insertedId: null,
  matchedCount: 1,
  modifiedCount: 1,
  upsertedCount: 0
}